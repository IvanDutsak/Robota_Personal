<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (API)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .input-glow {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }
    </style>
</head>
<body class="min-h-screen text-white p-8">

    <div class="container mx-auto max-w-4xl">
        <h1 class="text-4xl font-bold text-center mb-8">–ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h1>

        <div class="glass-effect rounded-2xl p-6 mb-8">
            <h2 class="text-2xl font-bold mb-4">1. –û–±–µ—Ä—ñ—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä–∏</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                
                <div>
                    <label for="point-id" class="block text-sm font-medium text-blue-200 mb-2">ID –ú–∞–≥–∞–∑–∏–Ω—É (Point ID):</label>
                    <input type="text" id="point-id" class="input-glow w-full rounded-lg p-3" value="eb4df5e8-e2c3-4beb-88ea-86684c4d6d97">
                </div>

                <div>
                    <label for="date-from" class="block text-sm font-medium text-blue-200 mb-2">–ó –¥–∞—Ç–∏:</label>
                    <input type="date" id="date-from" class="input-glow w-full rounded-lg p-3 text-white" style="color-scheme: dark;">
                </div>

                <div>
                    <label for="date-to" class="block text-sm font-medium text-blue-200 mb-2">–ü–æ –¥–∞—Ç—É:</label>
                    <input type="date" id="date-to" class="input-glow w-full rounded-lg p-3 text-white" style="color-scheme: dark;">
                </div>

            </div>
            
            <button id="fetch-data-btn" class="btn-primary w-full font-bold py-3 px-6 rounded-lg text-lg mt-6">
                –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ
            </button>
            <div id="loading-spinner" class="hidden text-center mt-4">
                <span class="text-lg">üåÄ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
            </div>
        </div>

        <div id="user-selection-section" class="glass-effect rounded-2xl p-6 mb-8 hidden">
            <h2 class="text-2xl font-bold mb-4">2. –û–±–µ—Ä—ñ—Ç—å –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞</h2>
            <select id="user-dropdown" class="input-glow w-full rounded-lg p-3 text-white">
                <option value="">-- –û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É --</option>
            </select>
        </div>

        <div id="results-section" class="glass-effect rounded-2xl p-6 hidden">
            <h2 class="text-2xl font-bold mb-4">3. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –¥–ª—è <span id="user-name" class="text-green-400"></span></h2>
            
            <div id="stats-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                </div>

            <div class="mt-8 text-center bg-gray-900 p-6 rounded-lg">
                <span class="text-xl text-blue-300">–ó–ê–ì–ê–õ–¨–ù–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢:</span>
                <h3 id="total-result" class="text-5xl font-bold text-green-400 mt-2">0.00</h3>
            </div>
        </div>

        <div id="error-message" class="hidden bg-red-600 p-4 rounded-lg mt-8 text-center"></div>

    </div>

    <script>
        // === –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ===
        // URL –≤–∞—à–æ–≥–æ –Ω–æ–≤–æ–≥–æ backend-—Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ Vercel
        const BACKEND_API_URL = "https://silpo-backend.vercel.app/"; // –í–ê–®–ê URL

        // –ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç–∏ (—â–æ–± –º–∏ –º–æ–≥–ª–∏ –ø–æ–∫–∞–∑—É–≤–∞—Ç–∏ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏)
        const COEFFICIENTS = {
            dcCollected: 1.40,
            storeCollected: 2.80,
            dcMoved: 3.45,
            placed: 1.59,
            weightPlacement: 0.14,
            packingOrder: 0.28
        };

        // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –¥–∞–Ω–∏—Ö
        let loadedStatistics = {};

        // === –ï–õ–ï–ú–ï–ù–¢–ò ===
        const fetchBtn = document.getElementById('fetch-data-btn');
        const userSelectionSection = document.getElementById('user-selection-section');
        const userDropdown = document.getElementById('user-dropdown');
        const resultsSection = document.getElementById('results-section');
        const statsGrid = document.getElementById('stats-grid');
        const totalResultEl = document.getElementById('total-result');
        const userNameEl = document.getElementById('user-name');
        const loadingSpinner = document.getElementById('loading-spinner');
        const errorMessageEl = document.getElementById('error-message');

        // === –û–ë–†–û–ë–ù–ò–ö–ò –ü–û–î–Ü–ô ===

        // 1. –ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –Ω–∞ –∫–Ω–æ–ø–∫—É "–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ"
        fetchBtn.addEventListener('click', async () => {
            // –û—Ç—Ä–∏–º—É—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è –∑ –ø–æ–ª—ñ–≤
            const pointId = document.getElementById('point-id').value;
            const fromDate = document.getElementById('date-from').value;
            const toDate = document.getElementById('date-to').value;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
            if (!pointId || !fromDate || !toDate) {
                showError("–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å ID –º–∞–≥–∞–∑–∏–Ω—É —Ç–∞ –æ–±–∏–¥–≤—ñ –¥–∞—Ç–∏.");
                return;
            }

            // –°–∫–∏–¥–∞—î–º–æ –≤—Å–µ —ñ –ø–æ–∫–∞–∑—É—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            resetUI();
            loadingSpinner.classList.remove('hidden');
            fetchBtn.disabled = true;

            try {
                // === –û–°–¨ –¢–£–¢ –í–Ü–î–ë–£–í–ê–Ñ–¢–¨–°–Ø –ú–ê–ì–Ü–Ø ===
                // –†–æ–±–∏–º–æ POST-–∑–∞–ø–∏—Ç –¥–æ –Ω–∞—à–æ–≥–æ backend-—É
                const response = await fetch(BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        from: fromDate,
                        to: toDate,
                        pointId: pointId
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    // –Ø–∫—â–æ Vercel –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É (–Ω–∞–ø—Ä., —Ç–æ–∫–µ–Ω –∑–∞—Å—Ç–∞—Ä—ñ–≤)
                    throw new Error(data.error || '–ù–µ–≤—ñ–¥–æ–º–∞ –ø–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                // === –£–°–ü–Ü–•! ===
                populateUserDropdown(data.usersList);
                loadedStatistics = data.statistics; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

                userSelectionSection.classList.remove('hidden');

            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ:", error);
                showError(`–ü–æ–º–∏–ª–∫–∞: ${error.message}. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ç–æ–∫–µ–Ω —É Vercel –∞–±–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è API.`);
            } finally {
                // –•–æ–≤–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                loadingSpinner.classList.add('hidden');
                fetchBtn.disabled = false;
            }
        });

        // 2. –í–∏–±—ñ—Ä –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞ –∑—ñ —Å–ø–∏—Å–∫—É
        userDropdown.addEventListener('change', () => {
            const selectedUserId = userDropdown.value;
            if (selectedUserId && loadedStatistics[selectedUserId]) {
                displayUserStats(loadedStatistics[selectedUserId]);
                resultsSection.classList.remove('hidden');
            } else {
                resultsSection.classList.add('hidden');
            }
        });

        // === –î–û–ü–û–ú–Ü–ñ–ù–Ü –§–£–ù–ö–¶–Ü–á ===

        // –ó–∞–ø–æ–≤–Ω—é—î –≤–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞–º–∏
        function populateUserDropdown(users) {
            userDropdown.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É --</option>'; // –°–∫–∏–¥–∞—î–º–æ
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.fullName;
                userDropdown.appendChild(option);
            });
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ–±—Ä–∞–Ω–æ–≥–æ –ø—Ä–∞—Ü—ñ–≤–Ω–∏–∫–∞
        function displayUserStats(stats) {
            userNameEl.textContent = stats.fullName;
            statsGrid.innerHTML = ''; // –û—á–∏—â—É—î–º–æ —Å—ñ—Ç–∫—É

            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–∞—Ä—Ç–∫–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–æ–∫–∞–∑–Ω–∏–∫–∞
            createStatCard("–ó—ñ–±—Ä–∞–Ω–æ —É –î–°", stats.raw.dcCollected, stats.calculated.dcCollected.toFixed(2));
            createStatCard("–ó—ñ–±—Ä–∞–Ω–æ —É –¢–ó", stats.raw.storeCollected, stats.calculated.storeCollected.toFixed(2));
            createStatCard("–ü–µ—Ä–µ–º—ñ—â–µ–Ω–æ", stats.raw.dcMoved, stats.calculated.dcMoved.toFixed(2));
            createStatCard("–†–æ–∑–º—ñ—â–µ–Ω–æ", stats.raw.placed, stats.calculated.placed.toFixed(2));
            createStatCard("–í–∞–≥–∞ —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è (–∫–≥)", stats.raw.weightPlacement.toFixed(2), stats.calculated.weightPlacement.toFixed(2));
            createStatCard("–ü–∞–∫—É–≤–∞–Ω–Ω—è (–∞—Ä—Ç–∏–∫—É–ª—ñ–≤)", stats.raw.packingOrder, stats.calculated.packingOrder.toFixed(2));
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –∑–∞–≥–∞–ª—å–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            totalResultEl.textContent = stats.totalResult.toFixed(2);
        }

        // –°—Ç–≤–æ—Ä—é—î –≥–∞—Ä–Ω—É –∫–∞—Ä—Ç–∫—É –¥–ª—è –ø–æ–∫–∞–∑–Ω–∏–∫–∞
        function createStatCard(title, rawValue, calculatedValue) {
            const card = document.createElement('div');
            card.className = "glass-effect p-4 rounded-lg";
            card.innerHTML = `
                <div class="text-sm text-blue-200 mb-1">${title}</div>
                <div class="text-xl font-bold text-white">${rawValue}</div>
                <div class="text-lg font-bold text-green-400 mt-2">= ${calculatedValue}</div>
            `;
            statsGrid.appendChild(card);
        }

        // –ü–æ–∫–∞–∑—É—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫—É
        function showError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
        }

        // –°–∫–∏–¥–∞—î —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É
        function resetUI() {
            errorMessageEl.classList.add('hidden');
            userSelectionSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            userDropdown.innerHTML = '<option value="">-- –û–±–µ—Ä—ñ—Ç—å –∑—ñ —Å–ø–∏—Å–∫—É --</option>';
            loadedStatistics = {};
        }

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Å—å–æ–≥–æ–¥–Ω—ñ—à–Ω—ñ –¥–∞—Ç–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-from').value = today;
            document.getElementById('date-to').value = today;
        });

    </script>
</body>
</html>
